var fs=require("fs");var zlib=require("zlib");var Zlib=require("./lib/Zlib").Zlib;var XML2Object = require('./lib/XML2Object');var yhnode=require("yhnode");var Download=yhnode.network.Download;var XMLHttpRequest=yhnode.network.http.XMLHttpRequest;var WorkPool=require("./lib/WorkPool").WorkPool;var assetPath="http://d3okqqck4korz7.cloudfront.net/images/";var gameImagePath=assetPath+"game_images/";var imageMapFile="./imagemap.xml";var localSavePath="./";var localGameImagePath=localSavePath+"game_images/";start(imageMapFile);function downloadImageMap(xmlContent) {    var files=getFiles(xmlContent);    downloadFiles(files);}function getFiles(xmlContent) {    var xml2Object=new XML2Object(true);    xml2Object.parse(xmlContent);    var root=xml2Object.getData();    return root.mappings;}function downloadFiles (files) {    var file;    var wp=new WorkPool(3);    for(var i in files){        file=files[i];        var srcPath=gameImagePath+file.path;        var saveTo=localGameImagePath+file.cname.replace(".","/")+".swf";        console.log("srcPath:",srcPath)                wp.add(handleDownload,null,srcPath,saveTo);    }}function handleDownload(task,srcPath,saveTo){	fs.exists(saveTo,function(v){	    if(v) {			console.log("skip:"+saveTo);			task.done();		}else{			var dl=new Download();            var retryTimes=3;			dl.on("sucess",function(){		        console.log("save ok:"+saveTo);		    });			dl.on("failure",function(){		        console.log("save failure:"+saveTo);		    });			dl.on("complete",function(){				task.done();		    });            dl.on("error",function(ex){                console.error(ex);                if(retryTimes-->0){				    dl.start(srcPath,saveTo,"binary");                }else{                    task.done();                }		    });		    dl.start(srcPath,saveTo,"binary");		}	});    }function start(imageMapFile){    if(imageMapFile.indexOf(".gz")==-1){        var imageMapContent=fs.readFileSync(imageMapFile);        downloadImageMap(imageMapContent.toString());    }else{        fs.readFile(imageMapFile,function(err,buf){            zlib.inflate(buf,function(e,data){                if(!e){        //            fs.writeFile("tt.xml",data);                    downloadImageMap(data.toString());                }            });        });    }}